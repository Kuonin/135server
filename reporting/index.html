<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Dashboard</title>
    <script nonce="undefined" src="https://cdn.zingchart.com/zingchart.min.js"></script>
    <script type="module">
        import './zinggrid.min.js';
    </script>
</head>
<body>
    <h1>Dashboard</h1>
    <div id='language'></div>
    <h2>User Clicks</h2>
    <a href="./clicks.html">Clicks Report</a>
    <div id="clicks"></div>
    <div id="pages"></div>
    <script>

    let lan = [];
    let languages = {};
    let lanLabels = [];
    let lanVals = [];
    fetch("https://reporting.katiel.site/api/static")
        .then((response) =>{
            return response.text();
        })
        .then((responses) => {
            let res = JSON.parse('[' + responses.replace(/}{(?=([^"]*"[^"]*")*[^"]*$)/g, '},{') + ']');
            for(const obj of res){
                let ln = obj.userLan;
                lan.push(ln);
                if(ln in languages)
                    languages[ln] += 1;
                else
                    languages[ln] = 1;
            }
            for(const key in languages){
                lanLabels.push(key);
                lanVals.push(languages[key]);
            }
            console.log(lan);
            console.log(lanLabels);
            console.log(lanVals);
            ZC.LICENSE = ["569d52cefae586f634c54f86dc99e6a9", "b55b025e438fa8a98e32482b5f768ff5"];
            let chartConfig = {
            type: 'bar',
            "title": {"text":"User Languages"},
            plotarea:{
                adjustLayout : true
            },
            scaleX :{
                label :{
                    text : "Browser Languages"
                },
                labels : lanLabels
            },
            series: [
                {values : lanVals}
            ]
            };
        
            zingchart.render({
            id: 'language',
            data: chartConfig,
            height: '100%%',
            width: '100%%'
            });
        })
        .catch(function(error){
            console.log(error);
        });
    
  </script>
  <script>
    let clicks = [];
    let idle = [];
    let pages = [];
    fetch("https://reporting.katiel.site/api/active")
        .then((response) =>{
            return response.text();
        })
        .then((responses) => {
            console.log(responses);
            let res = JSON.parse('[' + responses.replace(/}{(?=([^"]*"[^"]*")*[^"]*$)/g, '},{') + ']');
            for(const obj of res){
                if('event' in obj){
                    let event = "event";
                    let objEvent = obj[event];
                    console.log(objEvent);
                    if(objEvent == "mouseclick(u)"){
                        clicks.push([obj['x'], obj['y']]);
                    }
                    else if(objEvent == "Page enter" || objEvent == "Page left"){
                        pages.push({values : [obj['sessionId'],obj['event'], obj['time']]});
                    }
                }
            }
            console.log(clicks);
            console.log(pages);
            ZC.LICENSE = ["569d52cefae586f634c54f86dc99e6a9", "b55b025e438fa8a98e32482b5f768ff5"];
            let chartConfig = {
            type: 'scatter',
            "title": {"text":"User Mouse Clicks"},
            scaleX: {values: "0:2000:100"},
            scaleY : {values: "0:2000:100"},
            series: [
                {values : clicks}
            ]
            };
            let gridConfig = {
                type : 'grid', 
                "title" : {"text" : "Users Entering and Leaving the Page"},
                series: pages
            }
        
            zingchart.render({
            id: 'clicks',
            data: chartConfig,
            height: '100%%',
            width: '100%%'
            });
            zingchart.render({
            id: 'pages',
            data: gridConfig,
            height: '100%%',
            width: '100%%'
            });
        })
        .catch(function(error){
            console.log(error);
        });
    
  </script>
</body>
</html>