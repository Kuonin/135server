<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Dashboard</title>
    <script nonce="undefined" src="https://cdn.zingchart.com/zingchart.min.js"></script>
</head>
<body>
    <h1>Dashboard</h1>
    <div id='language'></div>
    <div id="clicks"></div>
    <div id="pie"></div>
    <script>

    let lan = [];
    let languages = {};
    let lanLabels = [];
    let lanVals = [];
    fetch("https://reporting.katiel.site/api/static")
        .then((response) =>{
            return response.text();
        })
        .then((responses) => {
            let res = JSON.parse('[' + responses.replace(/}{(?=([^"]*"[^"]*")*[^"]*$)/g, '},{') + ']');
            for(const obj of res){
                let ln = obj.userLan;
                lan.push(ln);
                if(ln in languages)
                    languages[ln] += 1;
                else
                    languages[ln] = 1;
            }
            for(const key in languages){
                lanLabels.push(key);
                lanVals.push(languages[key]);
            }
            console.log(lan);
            console.log(lanLabels);
            console.log(lanVals);
            ZC.LICENSE = ["569d52cefae586f634c54f86dc99e6a9", "b55b025e438fa8a98e32482b5f768ff5"];
            let chartConfig = {
            type: 'bar',
            "title": {"text":"User Languages"},
            plotarea:{
                adjustLayout : true
            },
            scaleX :{
                label :{
                    text : "Browser Languages"
                },
                labels : lanLabels
            },
            series: [
                {values : lanVals}
            ]
            };
        
            zingchart.render({
            id: 'language',
            data: chartConfig,
            height: '100%%',
            width: '100%%'
            });
        })
        .catch(function(error){
            console.log(error);
        });
    let clicks = [];
    let idle = [];
    let pages = [];
    fetch("https://reporting.katiel.site/api/active")
        .then((response) =>{
            return response.text();
        })
        .then((responses) => {
            let res = JSON.parse('[' + responses.replace(/}{(?=([^"]*"[^"]*")*[^"]*$)/g, '},{') + ']');
            for(const obj of res){
                if('events' in obj){
                    if(obj['event'] == "mouseclick(u)"){
                        clicks.push([obj['x'], obj['y']]);
                    }
                    else if(obj['event'] == "Page enter" || obj['event'] == "Page left"){
                        pages.push(obj);
                    }
                }
            }
            console.log(clicks);
            console.log(pages);
            ZC.LICENSE = ["569d52cefae586f634c54f86dc99e6a9", "b55b025e438fa8a98e32482b5f768ff5"];
            let chartConfig = {
            type: 'scatter',
            "title": {"text":"User Mouse Clicks"},
            series: [
                {values : [[1,2], [2,3]]}
            ]
            };
        
            zingchart.render({
            id: 'clicks',
            data: chartConfig,
            height: '100%%',
            width: '100%%'
            });
        })
        .catch(function(error){
            console.log(error);
        });
    
  </script>
</body>
</html>